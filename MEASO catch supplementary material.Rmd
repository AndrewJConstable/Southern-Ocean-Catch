---
title: "MEASO fishery statistics"
author: "Andrew Constable"
date: "16/09/2020"
output: 
  html_document:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(scales)
library(png) # for grabbing dimensions of png files
library(dplyr)


WorkDir<-('C:\\_w\\_d\\Catch\\')

# Editing and Development Notes:
#
# 1. This code is inherited from "MEASO CCAMLR catch data.rmd" which has the basic analyses testing the data.  
            # The code here strips away the testing routines.
#

#############################################################
# data files needed to support analyses

ASD_depth_propInMEASOareas<-readRDS("C:/_w/_r/Southern-Ocean-Catch/ASD_depth_propInMEASOareas.rds")

# files from CCAMLR Statistical Bulletin 2019

CSBdata           <-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\AggregatedFisheryCatch.csv',sep="")
                              , header = TRUE, sep = ",", dec = ".")
CEdata            <-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\AggregatedFisheryEffort.csv',sep="")
                              , header = TRUE, sep = ",", dec = ".")
CRcountry         <-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\ReferenceDataCountry.csv',sep="")
                              , header = TRUE, sep = ",", dec = ".")
CRfishingActivity <-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\ReferenceDataFishingActivity.csv',sep="")
                              , header = TRUE, sep = ",", dec = ".")
CRfishingGear     <-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\ReferenceDataFishingGear.csv',sep="")
                              , header = TRUE, sep = ",", dec = ".")
CRgeographicArea  <-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\ReferenceDataGeographicArea_to_MEASO.csv',sep="")
                              , header = TRUE, sep = ",", dec = ".")
CRvesselSize      <-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\ReferenceDataVesselSize.csv',sep="")
                              , header = TRUE, sep = ",", dec = ".")
CSB_taxa          <-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\ReferenceDataTaxon_MEASO.csv',sep="")
                              , header = TRUE, sep = ",", dec = ".")

# files with results from assignment of records to location of fishing gears - bottom (B) or midwater (M)
resultsDir<-"C:/_w/_r/Southern-Ocean-Catch/"
data_Location_B_M_Step_1<-read.csv2(paste(resultsDir,'B-M Step1.csv',sep="")
                              , header = TRUE, sep = ",", dec = ".")
data_Location_B_M_Step_2<-read.csv2(paste(resultsDir,'B-M Step2.csv',sep="")
                              , header = TRUE, sep = ",", dec = ".")

#############################################################
# input data to support analyses

TF_Names<-data.frame(TFn     = c(           1,        2,          3,           4,           5,      6,      7,      8)
                    ,Fishery = c("Groundfish","Icefish","Toothfish","Silverfish","Myctophids","Krill","Squid","Crabs")
                    ,Colour  = c("darkslategray","grey80","bisque3","lightsteelblue1","thistle3","coral2","cadetblue4","salmon4"))

GT_Names<-data.frame(GTn      = c(   1,    2,    3,    4,   5,   6,    7,    8,   9,   10,  11)
                    ,Gear     = c("TX", "OT","OTB","TBB","OTM","TMB","TM","LLS","FPO","JIG","SX")
                    ,Location = c( "B",  "U",  "B",  "B",  "M",  "M", "M",  "B",  "B",  "M", "M")  # midwater = "M", bottom = "B"
                    ,Colour   = c("grey5","grey20","grey35","grey50","darkslategray4","darkslategray3","darkslategray2","coral3","coral1","orchid3","firebrick"))

CT_Names<-data.frame(
          CTn      = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26)
         ,CTY_Code = c("ARG", "AUS", "BGR", "CHL", "CHN", "FRA", "DDR", "DEU", "IND", "JPN", "KOR", "LVA", "NAM"
                      ,"NOR", "NZL", "PAN", "POL", "RUS", "SUN", "UKR", "ZAF", "ESP", "GBR", "USA", "URY", "VUT")
         ,Colour   = c("grey25", "grey60", "grey25", "grey60", "grey25", "grey60"
                      ,"grey25", "grey60", "grey25", "grey60", "grey25", "grey60"
                      ,"grey25", "grey60", "grey25", "grey60", "grey25", "grey60"
                      ,"grey25", "grey60", "grey25", "grey60", "grey25", "grey60"
                      , "grey25", "grey60")
) # end dataframe


# details for reporting catch composition - BFTaxa

tCode          <- c("TOP","TOA","GRV","MCC","SRX","RAJ","ANT","WGR","GR2","RFA","GR1","ANI","NOS","BYR","LIC","SRR","NOR"
                    ,"ANS","GHP","NOG","NOT","NOX","ICX","KIF","SGI","SSI","WIC","KRI","LXX","MZZ","TRL","ELC","SQA","SPX","SQS","KCF","KCV")
Catch_Group   <- c(4,5,6,6,7,7,8,6,6,7,6,3,10,7,9,7,1
                   ,12,2,2,2,2,9,9,9,9,9,13,14,16,15,14,17,18,17,11,11)

BT_name                     <- c("Notothenia rossii"
                             ,"Other Groundfish"
                             ,"Mackerel Icefish"
                             ,"Dissostichus eleginoides"
                             ,"Dissostichus mawsoni"
                             ,"Grenadiers"
                             ,"Skates & rays"
                             ,"Antimora spp."
                             ,"Other icefish"
                             ,"Lepidonotothen squamifrons"
                             ,"Crabs"
                             ,"Silverfish"
                             ,"Krill"
                             ,"Myctophids"
                             ,"Trematomus spp."
                             ,"Unknown fish"
                             ,"Squid"
                             ,"Salps")

BFTaxa <- data.frame(Code = tCode,Catch_Group) 
Taxon_Name<-BT_name[match(BFTaxa[,"Catch_Group"],c(1:length(BT_name)))]
BFTaxa<-cbind(BFTaxa,Taxon_Name)


########################################################################
# General utility functions


fnCatch_summary<-function(fLevel,dCSB,f,BFTaxa,Threshold){

     fn<-length(f)
     rInclude<-apply(dCSB[,f],1,function(f,fn,fLevel){res<-f %in% fLevel;if      (sum(res)<fn) return(FALSE) else return(TRUE)},fn,fLevel)

     df1<-dCSB[rInclude,c("Calendar_Year","Catch_TXN_Code","Green_Weight")]
     ByList<-lapply(c("Calendar_Year","Catch_TXN_Code"),function(f,df){return     (df[,f])},df1)

     df2<-aggregate(df1[,"Green_Weight"],by=ByList,sum)
       dimnames(df2)[[2]]<-c("Year","Taxon","Tonnes")
  
       df3<-df2[df2[,"Tonnes"]>Threshold,]
       if(nrow(df3)>0){
       df4<-aggregate(df3[,"Tonnes"],by=list(df3[,"Taxon"]),sum)
       dimnames(df4)[[2]]<-c("Taxon","Tonnes")
  
       df5<-data.frame(TaxaGroup =
               BFTaxa[match(df4[,"Taxon"],BFTaxa[,"Code"]),"Catch_Group"]
              ,Tonnes = df4[,"Tonnes"])
       df6<-aggregate(df5[,"Tonnes"],list(df5[,"TaxaGroup"]),sum)  
       dimnames(df6)[[2]]<-c("TaxaGroup","Tonnes")  
       df7<-df6[order(df6[,"Tonnes"], decreasing=TRUE),]
       df7[,"Taxon"]<-BFTaxa[match(df7[,"TaxaGroup"],BFTaxa[,"Catch_Group"])
                            ,"Taxon_Name"]

       } else df7<-NULL # end if nrow(df3)>0

     cat("Catch summary for factors (",paste(f,collapse=", "),") with combined levels: ",paste(fLevel,collapse=", "),"\n\n",sep="")   
  
      if (!is.null(df7)) print.data.frame(df7[,c(3,2)]) else 
                print("Catches lower than threshold")
      cat("\n",sep="") 

     } # end catch_summary



```

# Introduction  
  
MEASO has a number of chapters that refer to, or detail, the nature and scale of fisheries over time.  The aim of this vignette is to describe the history of fisheries in the Southern Ocean and how that history varies between MEASO areas.  Section 2 details finfish and krill fisheries in the Southern Ocean.  Sections 3 and 4 detail catches of whales and seals respectively.  Incidental mortality of seabirds is considered separately to Southern Ocean fisheries because of the mortality of Southern Ocean seabirds throughout the Southern Hemisphere. This is documented in Section 5.  
   
# Finfish and krill fisheries   
  
CCAMLR provides the main source of information on finfish and krill fisheries (www.ccamlr.org), although other sources are useful for clarifying the locations and scale of catches prior to the establishment of CCAMLR in 1980 (e.g. Duhamel Kerguelen) and for the scale of incidental mortality of Southern Ocean seabirds in longline fisheries in the Southern Hemisphere (www.acap.aq).  
  
Here I use catch and effort data available in the CCAMLR Statistical Bulletin (https://www.ccamlr.org/en/publications/statistical-bulletin) as the primary source of data (hereafter referred to as CSB data). After securing permission from data owners, the CCAMLR Secretariat extracted catch and effort data that could be assigned to MEASO areas, which were data submitted for each haul (hereafter referred to as Haul Data). As the latter data required geolocation of catches, these data were not inclusive of all data in the Statistical Bulletin.   
  
The reason for the discrepancy is that early data were not required to be submitted with haul information and, instead, were simply summaries of catch and effort by CCAMLR reporting areas - Statistical Areas, Subareas or Divisions (herafter ASD areas). The scale of aggregation of submitted data varied between reporting nation.  Even since the requirement for reporting by haul, there remains discrepancies between the aggregated Bulletin Data and aggregated Haul Data.  
  
The attributes of the Bulletin and Haul datasets are described in Section 2.1, along with the discrepancies between them.  
  
Sections 2.2 and 2.3 detail the two methods used to partition the CSB data into MEASO Areas:  
- for finfish: proportion of fishable sea bed area (trawl and longline respectively) in CCAMLR ASD areas that fall within different MEASO areas, and
- for krill: the approximate proportion of catch from CCAMLR ASD falling within different MEASO areas derived from fine-scale maps of decadal catch provided by the CCAMLR Secretariat in Kawaguchi & Nicol (2020).  
  
   
## Relationship between CCAMLR and MEASO areas  
  
The MEASO and CCAMLR areas are shown with their naming conventions in Figure \@ref(fig:CCAMLR-MEASO-areas).  
  
  
```{r CCAMLR-MEASO-areas, out.width="40%", fig.cap="*CCAMLR statistical reporting areas (left) and MEASO areas (right - red lines indicate zones, black dashed lines indicate sectors)*", fig.show='hold', fig.align='center', echo=FALSE}
knitr::include_graphics(c(paste(WorkDir,"CCAMLR_areas.png",sep=""),paste(WorkDir,"MEASO_areas.png",sep="")))
```
  
    
The MEASO areas do not perfectly align with CCAMLR areas (Figure \@ref(fig:CCAMLR-MEASO-overlay)).  

  
```{r CCAMLR-MEASO-overlay, out.width="70%", fig.cap="CCAMLR statistical reporting areas (blue) overlaid on the MEASO areas (red lines)", fig.align='center', echo=FALSE}
knitr::include_graphics(paste(WorkDir,"MEASO-CCAMLR_combined_areas.png",sep=""))
```

Where ASD areas overlap MEASO areas, the proportional distribution of depth strata relevant for fishing are given in the following table.  Data are rounded to two decimal places.  As a result, some rounding results in showing no overlap (proportion in one MEASO area = 1).


```{r ASD_MEASO_compare, echo=FALSE}

# use data from file read into ASD_depth_propInMEASOareas

Depth_intervals<-unique(ASD_depth_propInMEASOareas[,"Depth"])

DepthRange<-NULL
for (d in seq(1,length(Depth_intervals),1)){
DepthRange <- if(d<length(Depth_intervals)) c(DepthRange,paste(-Depth_intervals[d],"-",-Depth_intervals[(d+1)]," m",sep="")) else
                                            c(DepthRange,paste("> ",-Depth_intervals[d]," m",sep = ""))
}
Depth<-data.frame(Interval = Depth_intervals,Range = DepthRange)

SplitASD<-apply(ASD_depth_propInMEASOareas[,c(3:16)],1,max)<1

df<-ASD_depth_propInMEASOareas[SplitASD &   # only records that are split across areas, exclude "Outside" rows and columns
                               ASD_depth_propInMEASOareas[,1]!="Outside",c(1:17)]
df[,c(3:17)]<-round(df[,c(3:17)],2)
SplitASD <- unique(df[,1])
df<-cbind(df,Depth[match(df[,2],Depth[,1]),2])
dimnames(df)[[2]][18]<-"DepthRange"


```


### Rules for splitting catch from ASD areas into MEASO areas

The matching of reporting areas and fisheries with MEASO areas had the greatest difficulty in Statistical Subareas 48.1 nd 48.3.  
  
In Subarea 48.1, the early groundfish fishery occurred around Elephant Island as well as around the islands off the West Antarctic Peninsula.  
  
In Subarea 48.3, the shelf area is wholly contained within the Subantarctic Zone, while the northern deep-water area, where krill fishing could occur, is in a retroflection of the Antarctic zone.  
  
[placeholder - describe how the division into MEASO areas was done and when the haul by haul took over.  Area 88 data should be correct because it was later]

Some catch and effort data are only allocated to statistical reporting areas without haul geolocations.  Those data were approximately allocated to MEASO areas according to a straight forward set of rules based on the target fishery from which the data came.  

#### Area 48  


*Subarea 48.1*  

Subarea 48.1 is split between the Atlantic sector and the East Pacific sector at the eastern tip of Joinville Island with a line crossing the Drake Passage.  The Atlantic sector includes the eastern margin of the Antarctic Peninsula and the shelf to the east of Joinville Island and around Elephant Island.  Bransfield Strait, the western margin of the Antarctic Peninsula and the South Shetland Islands are included in the East Pacific Sector.  The Atlantic sector within the subarea is wholly within the Antarctic zone.  The component of the subarea in the East Pacific Sector has parts in the Antarctic and Subantarctic Zones.  

Bottom trawl fishing around Joinville Island is included in the East Pacific.  Bottom trawling around Elephant Island is included in the Atlantic.  
  
```{r,echo=FALSE}
a<-"48.1"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)

```

*Subarea 48.2*  

Subarea 48.2 is in the Atlantic sector with its northern margin crossing into the Subantarctic Zone.  All the fishing areas in this subarea are in the Antarctic zone.  
  
```{r,echo=FALSE}
a<-"48.2"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```

*Subarea 48.3*  
  
Subarea 48.3 is in the Atlantic sector with the Southern ACC Front extending from the east of the area to the north and west before returning to the east.  The island, shelf and bank areas sit primarily in the Subantarctic Zone.   

Fishing for bentho-pelagic finfish has occurred primarily in shelf areas.  Myctophid fishing has occurred in the north of the subarea near Morris Ewing Bank.  Krill fishing occurs primarily on the northern shelf slope.  

All fisheries occur in the Subantarctic Zone.  Occasionally, krill fishing has occurred in the Antarctic Zone (CCAMLR Secretariat, 2020).


```{r,echo=FALSE}
a<-"48.3"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```

*Subarea 48.4*  
  
Subarea 48.4 is in the Atlantic sector.  The islands and shelf areas are within the Antarctic Zone, while the northern area is in the Subantarctic Zone.  
  
All fisheries occur in the Antarctic Zone.  
  
```{r,echo=FALSE}
a<-"48.4"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```
  
*Subarea 48.5*  
  
Subarea 48.5 is in the Atlantic sector and wholly within the Antarctic Zone.  
  
  
*Subarea 48.6*  
  
Subarea 48.6 is in the Atlantic sector.  The island and shelf areas in the northern part of this subarea are primarily within the Antarctic Zone, although some deeper water areas below 1000 m lie in the Subantarctic Zone.    
  
All fisheries occur in the Antarctic Zone.  
  
```{r,echo=FALSE}
a<-"48.6"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```
  
#### Area 58   

Catches in Area 58 have been reported as coming from the whole area, from subareas, and from the divisions within subareas.

*Subarea 58.4*  

Subarea 58.4 is split between the Central Indian Sector and the East Indian Sector.  It also crosses the Antarctic and Subantarctic Zones.  Krill fishing is contained within the Antarctic Zone.  Finfishing has occurred in both zones.


**Division 58.4.1**  
  
Division 58.4.1 crosses between the Central Indian Sector and the East Indian Sector at 115oE, and is mostly in the Antarctic Zone.  The northern part of this division is in deep water in the Subantarctic Zone.

All fisheries occur in the Antarctic Zone.  
  
```{r,echo=FALSE}
a<-"58.4.1"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```

**Division 58.4.2**  
  
Division 58.4.2 falls within the Central Indian Sector and the Antarctic Zone.  A small deep water area in the north east of this division is in the Subantarctic Zone.

All fisheries occur in the Antarctic Zone.  
  
```{r,echo=FALSE}
a<-"58.4.2"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```


**Division 58.4.3a**
  
Division 58.4.3a is in the Central Indian Sector and falls almost entirely in the Subantarctic Zone.
  
```{r,echo=FALSE}
a<-"58.4.3a"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```
  
**Division 58.4.3b**  
  
Division 58.4.3b is in the Central Indian Sector and falls mostly in the Subantarctic Zone.  The deeper eastern margin of BANZARE Bank is in the Antarctic Zone.  
  
Finfish fisheries occur in the Subantarctic Zone.  
  
```{r,echo=FALSE}
a<-"58.4.3b"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```
  
**Division 58.4.4a**  

Division 58.4.4a is in the Central Indian Sector.  It is split between the Antarctic Zone where krill fishing occurs and the Subantarctic Zone where finfishing has occurred on the Ob seamount.  
  
```{r,echo=FALSE}
a<-"58.4.4a"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```
  
**Division 58.4.4b**  
  
Division 58.4.4b is in the Central Indian Sector.  It is split between the Antarctic Zone where krill fishing occurs and the Subantarctic Zone where finfishing has occurred on the Lena and other seamounts.  
  
```{r,echo=FALSE}
a<-"58.4.4b"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```
  
*Subarea 58.5*  

Subarea 58.5 contains two divisions (58.5.1, 58.5.2) and is in the Central Indian Sector, falling mostly in the Subantarctic Zone.  The deep water northeast corner of Division 58.5.1 sits in the Northern Zone.  
  
All fisheries occur within the Subantarctic Zone.  
  
**Division 58.5.1**
  
```{r,echo=FALSE}
a<-"58.5.1"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```
  
*Subarea 58.6*  
   
Subarea 58.6 is in the Central Indian Sector, falling mostly in the Subantarctic Zone.  The northwest corner over Delcano Rise is in the Northern Zone.
  

```{r,echo=FALSE}
a<-"58.6"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```
  
*Subarea 58.7*  
  
Subarea 58.7 is in the Central Indian Sector.  It is split between the Subantarctic Zone and the Northern Zone.  Most shallow water area is around the islands and shelf area in the Northern Zone. 
  
Fisheries occur in the Northern Zone.  
  
```{r,echo=FALSE}
a<-"58.7"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```
  
#### Area 88
  
Early fishing interest in Area 88 was in the western margins around the Balleny Islands.

*Subarea 88.1*  
  
Subarea 88.1 crosses between the East Indian Sector and the West Pacific Sector at Cape Adare, and is mostly in the Antarctic Zone.  The northern part of this subarea is in deep water in the Subantarctic Zone.  
  
All fisheries occur in the Antarctic Zone.  
  
```{r,echo=FALSE}
a<-"88.1"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```

*Subarea 88.2*  
  
Subarea 88.2 crosses between the West Pacific Sector and the East Pacific Sector at 125oW, and is mostly in the Antarctic Zone.  The northeast part of this subarea in the East Pacific Sector is in deep water in the Subantarctic Zone.  
  
All fisheries occur in the Antarctic Zone.  
  
```{r,echo=FALSE}
a<-"88.2"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```
  
*Subarea 88.3*  
  
Subarea 88.3 is in the East Pacific Sector.  It is split between the Antarctic and Subantarctic Zones with shallow areas occurring almost entirely in the Antarctic Zone.

All fisheries occur in the Antarctic Zone.  
  
```{r,echo=FALSE}
a<-"88.3"; print.data.frame(df[df[,1]==a,c(18,3:17)],2,row.names = FALSE)
```
  
    
## CCAMLR Statistical Bulletin  
  
The CCAMLR Statistical Bulletin 2019 contains catch and effort records for fisheries up to the 2017-2018 split year. It comprised separate catch and effort files, along with files containing data on each of the factors.    
    
Each of the variables in the CCAMLR Statistical Bulletin (CSB) tables are described here along with a printout of the levels in each.

**AFC_ID**  Unique identifier for AGGREGATED FISHERY CATCH (system generated)[this identifier is in catch table but not included in the effort table]  

**AFE_ID** Unique identifier for the related record in AGGREGATED FISHERY EFFORT (system generated)[this identifier is in both catch data and effort data and used to link the two tables] 

**Flag_CTY_Code**  ISO 3 code for the flag of the fishing vessel(s).[in both catch and effort tables]  

**Calendar_Year**  Calendar year (YYYY) when fishing occurred.[in both catch and effort tables]  

**Month**  Month (MM) when fishing occurred.[in both catch and effort tables]  

**GAR_Code**  Geographic area code for the statistical area, subarea or division where fishing occurred. [in both catch and effort tables]  

**Target_TXN_Code**  3 alpha code for target taxon.[in both catch and effort tables]  

**GTY_Code**  Code for the gear used during fishing.[in both catch and effort tables]  

**FAC_Code**  Code for the fishing activity.[in both catch and effort tables]  

**VSZ_Code**  Code for the size category of fishing vessels based on gross tonnage.[in both catch and effort tables]  

**Catch_TXN_Code**  3 alpha code for each taxon caught.[only in catch table]  

**Green_Weight**  Green weight (tonne) of the catch.[only in catch table]  

**Fishing_Hours**  Total number of hours of fishing.[only in effort table]  

**Fishing_Days**  Total number of days during which fishing occurred.[only in effort table]  

**Vessel_Count**  Total number of vessels fishing.[only in effort table]  

**Haul_Count**  Total number of hauls made during fishing.[only in effort table]  

**Hook_Count**  Total number of hooks set. Applies to longline fishing only.[only in effort table]  

**Pot_Count**  Total number of pots set. Applies to pot fishing only.[only in effort table]  
  
  
Additional factors added to each record from the Bulletin:  
  
**Split_Year**  FAO reporting, 1 July to 30 June, with year identified for June.  
  
**CC_Season**  CCAMLR Season, 1 December to 30 November, with year identified for November.  
  
```{r ,echo=FALSE}
# CSBdata is the main data frame with catch records

CC_Season<-CSBdata[,"Calendar_Year"]
NextYear<-!is.na(CSBdata[,"Month"]) & CSBdata[,"Month"]>11
CC_Season[NextYear]<-CC_Season[NextYear]+1
Split_Year<-CSBdata[,"Calendar_Year"]
NextYear<-!is.na(CSBdata[,"Month"]) & CSBdata[,"Month"]>6
Split_Year[NextYear]<-Split_Year[NextYear]+1
CSBdata<-cbind(CSBdata,CC_Season,Split_Year)

```
  
### Summary of fisheries  
  
#### Target Fisheries  
  
Records are assigned in the database to fisheries according to target species.  These are further grouped to differentiate earlier bottom trawl groundfish fisheries, which principally targetted *Notothenia rossii* and other notothenids, from the other fisheries.  The groundfish fisheries had various assignments of target species and are grouped here as a 'groundfish' fishery.  

A new factor was added to the main data frame with details in a reference data frame:

**TFN**  Fishery number assigned to the record, as per the legend sequence in Figure 1.

Records were checked for their assignment to target fisheries based on the dominant species caught over the course of one year in that fishery, aggregated according to nominated gear types.  Records having patterns of aggregated catches that did not match the general pattern of dominant species caught were reassigned to other fisheries for which the pattern was more similar.  This only occurred for catches in the groundfish, mackerel icefish and krill fisheries in the 1970s prior to CCAMLR.

  
```{r target-fisheries, out.width="70%", fig.cap="*Figure 1: Total catch (tonnes, all taxa) in each major fishery in the CCAMLR area in each decade from the 1960s to the present, derived from the CCAMLR Statistical Bulletin 2019*", fig.show='hold', fig.align='center', echo=FALSE}
TargetFishery<-CSB_taxa[unique(match(CSBdata[,"Target_TXN_Code"],CSB_taxa[,"TXN_Code"])),]
TF_Plot_Order<-data.frame(TFn      = c(     3,     2,     7,     1,     6,     5,      1,    2,     1 
                                            ,    5,     1,     4,     8,     1,     2)
                              ,TXN_Code = c( "TOT", "ANI", "SQS", "MZZ", "KRI", "LXX", "NOX", "ICX", "NOG"
                                            ,"ELC", "GHP", "ANS", "KCX", "NOS", "WIC")
  )
TF_Plot_Order<-TF_Plot_Order[order(TF_Plot_Order[,"TFn"]),]


# create vector to be added to CSBdata for the Target fishery for each record

Fishery_type<-TF_Plot_Order[match(CSBdata[,"Target_TXN_Code"],TF_Plot_Order[,"TXN_Code"]),"TFn"]  # plot by number of Target Fishery to get right order 

CSBdata<-cbind(CSBdata,Fishery_type)
dimnames(CSBdata)[[2]][length(names(CSBdata))]<-"TFN"

# add zeros for each Fishery*Decade 

decade<-seq(1960,2010,10)
TFzeros<-do.call(rbind,lapply(seq(1,length(decade),1),function(t,decade,TFn){return(data.frame(Decade=rep(decade[t],length(TFn))
                                                                                              ,Fishery=TFn
                                                                                              ,Tonnes=rep(0,length(TFn))
                                                                                              ))},decade,TF_Names[,"TFn"]))

res1<-data.frame(Decade=10*(floor(CSBdata[,"Calendar_Year"]/10))
                ,Fishery=CSBdata[,"TFN"]
                ,Tonnes = CSBdata[,"Green_Weight"])
res1<-rbind(res1,TFzeros)
res<-as.data.frame(aggregate(res1[,"Tonnes"],list(res1[,"Decade"],res1[,"Fishery"]),sum))
dimnames(res)[[2]]<-c("Decade","Fishery","Tonnes")


plotYlog<-TRUE

if(plotYlog){
  res[res[,"Tonnes"]<1,"Tonnes"]<-1
   }

p <- ggplot()
p <- p + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()
               ,panel.background = element_blank()
               , axis.line = element_line(colour = "black",size=1, linetype="solid"))

p<- p+ geom_col(res, mapping = (aes(x = factor(res[,"Decade"]), y = res[,"Tonnes"], fill = factor(res[,"Fishery"]))),position = position_dodge(preserve = 'single'))
p <- p + labs(x = "Decade", y ="Tonnes", fill = "Fishery",title="Total catch by decade for type of fishery")
if (plotYlog) p <- p + scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),labels = trans_format("log10", math_format(10^.x)), limits = c(1E0,1E8)) + annotation_logticks(sides="l")
p <- p + scale_fill_discrete(name = "Fishery", breaks=levels(factor(res[,"Fishery"])),labels = TF_Names[as.character(TF_Names[,"TFn"])  %in%  levels(factor(res[,"Fishery"])),"Fishery"],type=TF_Names[,"Colour"]) # change legend labels

p

```
  
#### Gear Type  
  
Gear types in the CCAMLR Statistical Bulletin have been specifically identified as bottom and midwater trawls, hooks and lines, pots and traps, squid jigging and seines.    
  
  
```{r GearType, out.width="70%", fig.cap="*Total catch (tonnes, all taxa) for each major gear type in the CCAMLR area in each decade from the 1960s to the present, derived from the CCAMLR Statistical Bulletin 2019*", fig.show='hold', fig.align='center', echo=FALSE}
#addmargins(xtabs(Green_Weight ~ Calendar_Year + GTY_Code, CSBdata))


# add zeros for each Fishery*Decade 

decade<-seq(1960,2010,10)
GTzeros<-do.call(rbind,lapply(seq(1,length(decade),1),function(t,decade,GT){return(data.frame(Decade=rep(decade[t],length(GT))
                                                                                              ,Gear=GT
                                                                                              ,Tonnes=rep(0,length(GT))
                                                                                              ))},decade,GT_Names[,"GTn"]))

res1<-data.frame(Decade=10*(floor(CSBdata[,"Calendar_Year"]/10))
                ,Gear=GT_Names[match(CSBdata[,"GTY_Code"],GT_Names[,"Gear"]),"GTn"]
                ,Tonnes = CSBdata[,"Green_Weight"])
res1<-rbind(res1,GTzeros)
res<-as.data.frame(aggregate(res1[,"Tonnes"],list(res1[,"Decade"],res1[,"Gear"]),sum))
dimnames(res)[[2]]<-c("Decade","Gear","Tonnes")

# exclude data
GTY_exclude<- GT_Names[match(c("TX","TBB"),GT_Names[,"Gear"]),"GTn"]     
res<-res[!(res[,"Gear"] %in% GTY_exclude),]
pGT_Names<- GT_Names[-(match(GTY_exclude,GT_Names[,"GTn"])),] 

plotYlog<-TRUE

if(plotYlog){
  res[res[,"Tonnes"]<1,"Tonnes"]<-1
   }

p <- ggplot()
p <- p + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()
               ,panel.background = element_blank()
               , axis.line = element_line(colour = "black",size=1, linetype="solid"))

p<- p+ geom_col(res, mapping = (aes(x = factor(res[,"Decade"]), y = res[,"Tonnes"], fill = factor(res[,"Gear"]))),position = position_dodge(preserve = 'single'))
p <- p + labs(x = "Decade", y ="Tonnes", fill = "Gear",title="Total catch by decade for gear type")
if (plotYlog) p <- p + scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),labels = trans_format("log10", math_format(10^.x)), limits = c(1E0,1E8)) + annotation_logticks(sides="l")
p <- p + scale_fill_discrete(name = "Gear", breaks=levels(factor(res[,"Gear"]))
                             ,labels = CRfishingGear[match(pGT_Names[
                                            match(as.character(pGT_Names[,"GTn"]),levels(factor(res[,"Gear"])))
                                            ,"Gear"],CRfishingGear[,"GTY_Code"]),"GTY_Name"]
                             ,type=pGT_Names[,"Colour"]) # change legend labels

p


```

  
Fisheries in the 1970s and 1980s were undertaken primarily using otter trawls.  While these trawls became regularly differentiated between bottom and midwater trawling since that time, those early years had a large proportion of trawling not differentiated (i.e. Otter Trawl nei).  As they comprise a large component of the early fisheries, an assessment of the potential historical effects of fishing on the ecosystem needs to assign these trawls to either bottom or midwater fishing.  A two step process was used to assign Otter Trawls Nei to either of the categories.

**Step 1**: Catches for individual taxa were aggregated using three factors - gear type, flag country, fishery.  They were initially aggregated with an additional factor, year, in order to exclude records for taxa with an annual catch less than 30 tonnes.  The data for taxa were then  aggregated across years within the combinations of the three main factors.  The pattern of relative abundance of taxa within the target fisheries and with gear type were used to check whether assignment to pelagic (midwater) or bottom fishing were likely to be correct.  For example, midwater fishing typically yielded large quantities of krill, myctophids and/or silverfish, the latter two rarely being seen in bottom trawls.  As a result of this checking, no trawls already assigned to midwater or bottom were changed.  For the unassigned otter trawls, the myctophid target fishery was assigned to midwater trawling.  The remainder were asigned to bottom trawling, except for the Groundfish and Krill target fisheries of the Soviet Union, which did not have clear catch patterns relating to either midwater or bottom fisheries (groundfish and krill were represented in equal measure).  These were further analysed in Step 2.  
  
  
```{r,echo=FALSE}
# visual inspection of aggregation according to th

# code to check assignment of location of fishing gear - bottom or midwater fisheries
CheckBottomFishAssignments<-FALSE
if(CheckBottomFishAssignments){
  Factors<-c("GTY_Code","Flag_CTY_Code","TFN")
  LevelCombinations<-unique(CSBdata[,Factors])
  apply(LevelCombinations,1,fnCatch_summary
        ,CSBdata,Factors,BFTaxa,Threshold=10)
  } # end if

# add location following inspection and creating a CSV file with relevant assignment from first step: data_Location_B_M_Step_1

dfTmp1<-merge(CSBdata,data_Location_B_M_Step_1,by=c("GTY_Code","Flag_CTY_Code","TFN"))

```
  
**Step 2**:  The Soviet Union data for unassigned otter trawls were examined by the combination of three factors - target fishery (only groundfish and krill were represented), CCAMLR catch reporting areas, and year.  For the groundfish fishery, some combinations were dominated by krill with comparatively few groundfish represented.  These were assigned to midwater trawling, with the remainder assigned to bottom fishing.
  
```{r,echo=FALSE}
# check OT,SUN,TFN=c(1,6) in more detail as still uncertain

CheckSUN_OTassignments<-FALSE
if(CheckSUN_OTassignments){
  dfSUN<-CSBdata[CSBdata[,"GTY_Code"]=="OT" 
              & CSBdata[,"Flag_CTY_Code"]=="SUN"
              & CSBdata[,"TFN"] %in% c(1,6),]
  Factors<-c("GTY_Code","Flag_CTY_Code","TFN","GAR_Code","Calendar_Year")
  LevelCombinations<-unique(dfSUN[,Factors])
  apply(LevelCombinations,1,fnCatch_summary
        ,dfSUN,Factors,BFTaxa,Threshold=10)
  } # end if

# modify location following inspection of SUN data for OT and creating a CSV file with relevant assignment from second step: data_Location_B_M_Step_2

dfTmp2<-merge(dfTmp1,data_Location_B_M_Step_2,by=c("GTY_Code","Flag_CTY_Code","TFN","GAR_Code","Calendar_Year"),all.x=TRUE)
dfTmp2[dfTmp2[,"Location.x"]=="U","Location.x"]<-dfTmp2[dfTmp2[,"Location.x"]=="U","Location.y"]
dimnames(dfTmp2)[[2]][dimnames(dfTmp2)[[2]]=="Location.x"]<-"Location"
CSBdata<-dfTmp2[,-which(dimnames(dfTmp2)[[2]] %in% "Location.y")]
GTY_rev<-CSBdata[,"GTY_Code"]
GTY_rev[GTY_rev=="OT"]<-unlist(lapply(CSBdata[GTY_rev=="OT","Location"],function(g){paste("OT",g,sep="")}))
CSBdata<-cbind(CSBdata,GTY_rev)

# plot revised assignments

res1<-data.frame(Decade=10*(floor(CSBdata[,"Calendar_Year"]/10))
                ,Gear=GT_Names[match(CSBdata[,"GTY_rev"],GT_Names[,"Gear"]),"GTn"]
                ,Tonnes = CSBdata[,"Green_Weight"])
res1<-rbind(res1,GTzeros)
res<-as.data.frame(aggregate(res1[,"Tonnes"],list(res1[,"Decade"],res1[,"Gear"]),sum))
dimnames(res)[[2]]<-c("Decade","Gear","Tonnes")

# exclude data
GTY_exclude<- GT_Names[match(c("TX","TBB","OT"),GT_Names[,"Gear"]),"GTn"]     
res<-res[!(res[,"Gear"] %in% GTY_exclude),]
pGT_Names<- GT_Names[-(match(GTY_exclude,GT_Names[,"GTn"])),] 

plotYlog<-TRUE

if(plotYlog){
  res[res[,"Tonnes"]<1,"Tonnes"]<-1
   }

p <- ggplot()
p <- p + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()
               ,panel.background = element_blank()
               , axis.line = element_line(colour = "black",size=1, linetype="solid"))

p<- p+ geom_col(res, mapping = (aes(x = factor(res[,"Decade"]), y = res[,"Tonnes"], fill = factor(res[,"Gear"]))),position = position_dodge(preserve = 'single'))
p <- p + labs(x = "Decade", y ="Tonnes", fill = "Gear",title="Total catch by decade for gear type with assigned OT")
if (plotYlog) p <- p + scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),labels = trans_format("log10", math_format(10^.x)), limits = c(1E0,1E8)) + annotation_logticks(sides="l")
p <- p + scale_fill_discrete(name = "Gear", breaks=levels(factor(res[,"Gear"]))
                             ,labels = CRfishingGear[match(pGT_Names[
                                            match(as.character(pGT_Names[,"GTn"]),levels(factor(res[,"Gear"])))
                                            ,"Gear"],CRfishingGear[,"GTY_Code"]),"GTY_Name"]
                             ,type=pGT_Names[,"Colour"]) # change legend labels

p

```
  

A revised GTY code is added to the main data frame along with an assignment of all fisheries to a location in the water column in which the gear was deployed:

**GTY_rev**    Revised GTY_Code to replace OT code
**Location**   Gear deployed on or near to the bottom (B) or midwater (M).



  
#### Nations

**Bentho-pelagic fisheries**  
  
  
**Pelagic fisheries**  
  

#### MEASO-CCAMLR reporting areas  

```{r,echo=FALSE}
# examine data reported for Areas as a whole

CheckStatAreaAssignments<-FALSE
if(CheckStatAreaAssignments){
dfArea<-CSBdata[CSBdata[,"GAR_Code"] %in% c("48","58","88"),]
  Factors<-c("GTY_Code","Flag_CTY_Code","TFN","GAR_Code","Calendar_Year")
  LevelCombinations<-unique(dfWholeStatArea[,Factors])
  apply(LevelCombinations,1,fnCatch_summary
        ,dfWholeStatArea,Factors,BFTaxa,Threshold=10)
  } # end if

Check58assignments<-FALSE
if(Check58assignments){
dfWholeStatArea<-CSBdata[CSBdata[,"GAR_Code"] %in% c("584","585"),]
  Factors<-c("GTY_Code","Flag_CTY_Code","TFN","GAR_Code","Calendar_Year")
  LevelCombinations<-unique(dfWholeStatArea[,Factors])
  apply(LevelCombinations,1,fnCatch_summary
        ,dfWholeStatArea,Factors,BFTaxa,Threshold=10)
  } # end if

CheckGeneralAssignments<-FALSE
if(CheckGeneralAssignments){
  Factors<-c("Split_Year","Flag_CTY_Code","GTY_Code","TFN","GAR_Code")
  LevelCombinations<-unique(CSBdata[,Factors])
  apply(LevelCombinations,1,fnCatch_summary
        ,CSBdata,Factors,BFTaxa,Threshold=10)
  } # end if
  

```


### The effects of fishing on the ecosystem

Method: Data for a fishery is extracted from the Bulletin and catches summed with the following factors: Year, Nation, Taxon. For each fishery, summaries are provided on:



*Groundfish*


```{r Fishery_Groundfish, echo=FALSE}

# taxonomic groups for reporting given catch thresholds



  
```

  
# check catches by species
  
cat("Total catch of individual tax (where a catch in one year by a nation of the taxon :",sep="")
     
  df<-aggregate(df2[,"Tonnes"],by=list(df2[,"Nation"]),sum)
  dimnames(df)[[2]]<-c("Nation","Tonnes")

  
# determine first and last years
  
  TrawlGfish_CTY<-df[,"Nation"]
  YearFirst<-unlist(do.call(rbind,lapply(TrawlGfish_CTY,function(c,dCSB){min(dCSB[dCSB[,"Nation"]==c,"Year"])},df2)))
  YearLast <-unlist(do.call(rbind,lapply(TrawlGfish_CTY,function(c,dCSB){max(dCSB[dCSB[,"Nation"]==c,"Year"])},df2)))
df<-cbind(df,YearFirst,YearLast)

```

# add zeros for each Nation*Decade 

decade<-seq(1960,2010,10)
CTzeros<-do.call(rbind,lapply(seq(1,length(decade),1),function(t,decade,CT){return(data.frame(Decade=rep(decade[t],length(CT))
                                                                                              ,Country=CT
                                                                                              ,Tonnes=rep(0,length(CT))
                                                                                              ))},decade,CT_Names[,"CTn"]))

res1<-data.frame(Decade=10*(floor(CSBdata[,"Calendar_Year"]/10))
                ,Gear=GT_Names[match(CSBdata[,"GTY_Code"],GT_Names[,"Gear"]),"GTn"]
                ,Tonnes = CSBdata[,"Green_Weight"])
res1<-rbind(res1,GTzeros)
res<-as.data.frame(aggregate(res1[,"Tonnes"],list(res1[,"Decade"],res1[,"Gear"]),sum))
dimnames(res)[[2]]<-c("Decade","Gear","Tonnes")




  
  
  p <- ggplot(df, aes(x = factor(df[,"Nation"]), y = df[,"Tonnes"], fill = factor(df[,"Country"])))
  p <- p + geom_col(position = "dodge")
  p <- p + labs(x = "Gear", y ="Tonnes", fill = "Country",title=paste(CatchTaxon[ct]," catch by gear for countries",sep=""))
  p<-p + scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),labels = trans_format("log10", math_format(10^.x)), limits = c(1E0,1E8)) + annotation_logticks(sides="l")
  p <- p + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()
               ,panel.background = element_blank()
               , axis.line = element_line(colour = "black",size=1, linetype="solid"))
#  p <- p + scale_fill_discrete(name = "Gear type", breaks=levels(factor(res[,"Gear"])),labels = CRfishingGear[CRfishingGear[,"GTY_Code"]  %in%  levels(factor(res[,"Gear"])),"GTY_Name"]) # change legend labels
  p
  
 plots<- c(plots,list(p))
 
} # end ct

```





The aim is to use combinations of gear, country, and taxa to isolate bottom fishing from pelagic fishing


ggplot(dat, 
       aes(Order, Value)) +
  geom_col(aes(fill = ID),
           position = position_dodge2(width = 0.5, preserve = "single")) +
  facet_grid(. ~ Day) +
  scale_x_continuous(
    breaks = dat$Order,
    labels = dat$ID)
    


