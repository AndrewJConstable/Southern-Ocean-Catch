---
title: "MEASO CCAMLR Catch data"
author: "Andrew Constable"
date: "29/06/2020"
output: 
  bookdown::html_document2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(png) # for grabbing dimensions of png files


WorkDir<-('C:\\_w\\_d\\Catch\\')

```

# Introduction  
  
MEASO has a number of chapters that refer to, or detail, the nature and scale of fisheries over time.  The aim of this vignette is to describe the history of fisheries in the Southern Ocean and how that history varies between MEASO areas.  Section 2 details finfish and krill fisheries in the Southern Ocean.  Sections 3 and 4 detail catches of whales and seals respectively.  Incidental mortality of seabirds is considered separately to Southern Ocean fisheries because of the mortality of Southern Ocean seabirds throughout the Southern Hemisphere. This is documented in Section 5.  
   
# Finfish and krill fisheries   
  
CCAMLR provides the main source of information on finfish and krill fisheries (www.ccamlr.org), although other sources are useful for clarifying the locations and scale of catches prior to the establishment of CCAMLR in 1980 (e.g. Duhamel Kerguelen) and for the scale of incidental mortality of Southern Ocean seabirds in longline fisheries in the Southern Hemisphere (www.acap.aq).  
  
Here I use catch and effort data available in the CCAMLR Statistical Bulletin (https://www.ccamlr.org/en/publications/statistical-bulletin) as the primary source of data (hereafter referred to as CSB data). After securing permission from data owners, the CCAMLR Secretariat extracted catch and effort data that could be assigned to MEASO areas, which were data submitted for each haul (hereafter referred to as Haul Data). As the latter data required geolocation of catches, these data were not inclusive of all data in the Statistical Bulletin.   
  
The reason for the discrepancy is that early data were not required to be submitted with haul information and, instead, were simply summaries of catch and effort by CCAMLR reporting areas - Statistical Areas, Subareas or Divisions (herafter ASD areas). The scale of aggregation of submitted data varied between reporting nation.  Even since the requirement for reporting by haul, there remains discrepancies between the aggregated Bulletin Data and aggregated Haul Data.  
  
The attributes of the Bulletin and Haul datasets are described in Section 2.1, along with the discrepancies between them.  
  
Sections 2.2 and 2.3 detail the two methods used to partition the CSB data into MEASO Areas:  
- for finfish: proportion of fishable sea bed area (trawl and longline respectively) in CCAMLR ASD areas that fall within different MEASO areas, and
- for krill: the approximate proportion of catch from CCAMLR ASD falling within different MEASO areas derived from fine-scale maps of decadal catch provided by the CCAMLR Secretariat in Kawaguchi & Nicol (2020).  
  
   
## Relationship between CCAMLR and MEASO areas  
  
The MEASO and CCAMLR areas are shown with their naming conventions in Figure \@ref(fig:CCAMLR-MEASO-areas).  
  
  
```{r CCAMLR-MEASO-areas, out.width="40%", fig.cap="*CCAMLR statistical reporting areas (left) and MEASO areas (right - red lines indicate zones, black dashed lines indicate sectors)*", fig.show='hold', fig.align='center', echo=FALSE}
knitr::include_graphics(c(paste(WorkDir,"CCAMLR_areas.png",sep=""),paste(WorkDir,"MEASO_areas.png",sep="")))
```
  
    
The MEASO areas do not perfectly align with CCAMLR areas (Figure \@ref(fig:CCAMLR-MEASO-overlay)).  The matching of reporting areas and fisheries with MEASO areas had the greatest difficulty in Statistical Subareas 48.1 nd 48.3.  
  
In Subarea 48.1, the early groundfish fishery occurred around Elephant Island as well as around the islands off the West Antarctic Peninsula.  
  
In Subarea 48.3, the shelf area is wholly contained within the Subantarctic Zone, while the northern deep-water area, where krill fishing could occur, is in a retroflection of the Antarctic zone.  
  
[placeholder - describe how the division into MEASO areas was done and when the haul by haul took over.  Area 88 data should be correct because it was later]
  
```{r CCAMLR-MEASO-overlay, out.width="70%", fig.cap="CCAMLR statistical reporting areas (blue) overlaid on the MEASO areas (red lines)", fig.align='center', echo=FALSE}
knitr::include_graphics(paste(WorkDir,"MEASO-CCAMLR_combined_areas.png",sep=""))
```

Some catch and effort data are only allocated to statistical reporting areas without haul geolocations.  Those data were approximately allocated to MEASO areas according to a straight forward set of rules based on the target fishery from which the data came.  
  
  
## CCAMLR Statistical Bulletin  
  
The CCAMLR Statistical Bulletin 2019 comprised separate catch and effort files, along with files containing data on each of the factors.  The following provides the first few lines of each loaded file.  
  
```{r CSB-Data-Load, echo=FALSE}
CSBdata<-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\AggregatedFisheryCatch.csv',sep=""), header = TRUE, sep = ",", dec = ".")
cat("CSB Catch data\n")
head(CSBdata)

CEdata<-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\AggregatedFisheryEffort.csv',sep=""), header = TRUE, sep = ",", dec = ".")
cat("CSB Effort data\n")
head(CEdata)

CRcountry<-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\ReferenceDataCountry.csv',sep=""), header = TRUE, sep = ",", dec = ".")
cat("CSB Reference data - country\n")
head(CRcountry)

CRfishingActivity<-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\ReferenceDataFishingActivity.csv',sep=""), header = TRUE, sep = ",", dec = ".")
cat("CSB Reference data - fishing activity\n")
head(CRfishingActivity)

CRfishingGear<-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\ReferenceDataFishingGear.csv',sep=""), header = TRUE, sep = ",", dec = ".")
cat("CSB Reference data - fishing gear\n")
CRfishingGear

CRgeographicArea<-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\ReferenceDataGeographicArea_to_MEASO.csv',sep=""), header = TRUE, sep = ",", dec = ".")
cat("CSB Reference data - geographic area\n")
head(CRgeographicArea)

CRvesselSize<-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\ReferenceDataVesselSize.csv',sep=""), header = TRUE, sep = ",", dec = ".")
cat("CSB Reference data - vessel size\n")
head(CRvesselSize)

CSB_taxa<-read.csv2(paste(WorkDir,'CCAMLR_2019_Stat_Bull_data_Files\\ReferenceDataTaxon_MEASO.csv',sep=""), header = TRUE, sep = ",", dec = ".")
cat("CSB Reference data - taxa (with major and minor groups by the author)\n")
head(CSB_taxa)

```

### Factor and variable descriptions

Each of the variables in the CCAMLR Statistical Bulletin (CSB) tables are described here along with a printout of the levels in each.

**AFC_ID**  Unique identifier for AGGREGATED FISHERY CATCH (system generated)[this identifier is in catch table but not included in the effort table]  

**AFE_ID** Unique identifier for the related record in AGGREGATED FISHERY EFFORT (system generated)[this identifier is in both catch data and effort data and used to link the two tables] 

**Flag_CTY_Code**  ISO 3 code for the flag of the fishing vessel(s).[in both catch and effort tables]  

```{r,echo=FALSE}
sort(unique(CSBdata[,"Flag_CTY_Code"]))
```
  
**Calendar_Year**  Calendar year (YYYY) when fishing occurred.[in both catch and effort tables]  

```{r,echo=FALSE}
sort(unique(CSBdata[,"Calendar_Year"]))
```
  
**Month**  Month (MM) when fishing occurred.[in both catch and effort tables]  

```{r,echo=FALSE}
sort(unique(CSBdata[,"Month"]))
```
  
**GAR_Code**  Geographic area code for the statistical area, subarea or division where fishing occurred. [in both catch and effort tables]  

```{r,echo=FALSE}
sort(unique(CSBdata[,"GAR_Code"]))
```
  
**Target_TXN_Code**  3 alpha code for target taxon.[in both catch and effort tables]  

```{r,echo=FALSE}
sort(unique(CSBdata[,"Target_TXN_Code"]))
```
  
**GTY_Code**  Code for the gear used during fishing.[in both catch and effort tables]  

```{r,echo=FALSE}
sort(unique(CSBdata[,"GTY_Code"]))
```
  
**FAC_Code**  Code for the fishing activity.[in both catch and effort tables]  


```{r,echo=FALSE}
sort(unique(CSBdata[,"FAC_Code"]))
```
  
**VSZ_Code**  Code for the size category of fishing vessels based on gross tonnage.[in both catch and effort tables]  

```{r,echo=FALSE}
sort(unique(CSBdata[,"VSZ_Code"]))
```
  
**Catch_TXN_Code**  3 alpha code for each taxon caught.[only in catch table]  

```{r,echo=FALSE}
sort(unique(CSBdata[,"Catch_TXN_Code"]))
```
  
**Green_Weight**  Green weight (tonne) of the catch.[only in catch table]  

**Fishing_Hours**  Total number of hours of fishing.[only in effort table]  

**Fishing_Days**  Total number of days during which fishing occurred.[only in effort table]  

**Vessel_Count**  Total number of vessels fishing.[only in effort table]  

**Haul_Count**  Total number of hauls made during fishing.[only in effort table]  

**Hook_Count**  Total number of hooks set. Applies to longline fishing only.[only in effort table]  

**Pot_Count**  Total number of pots set. Applies to pot fishing only.[only in effort table]  



### Assigning factors for sumamrising fisheries

**Target Fisheries**  
  
Records are assigned in the database to fisheries according to target species.  These are further grouped to differentiate earlier bottom trawl groundfish fisheries, which principally targetted *Notothenia rossii* and other notothenids, from the other fisheries.  The groundfish fisheries had various assignments of target species and are grouped here.  The target fishery groups are:

```{r target-fisheries, echo=FALSE}
# check for missing values
cat("Target Taxon: check for missing values\n     Number of records = "
    ,nrow(CSBdata),"  : Records not missing = ",length(CSBdata[!is.na(CSBdata[,"Target_TXN_Code"]),"Target_TXN_Code"]))

TargetFishery<-CSB_taxa[unique(match(CSBdata[,"Target_TXN_Code"],CSB_taxa[,"TXN_Code"])),]
Fishery<-c("Toothfish","Icefish","Squid","Groundfish","Krill","Myctophid","Groundfish","Icefish","Groundfish","Myctophid","Groundfish","Silverfish","Crab","Groundfish","Icefish")
TargetFishery<-cbind(Fishery,TargetFishery)
TargetFishery<-TargetFishery[order(TargetFishery[,"Fishery"],TargetFishery[,"Taxa_Group_major"],TargetFishery[,"Taxa_Group"],TargetFishery[,"TXN_Name"]),]
TargetFishery

# create vector to be added to CSBdata for the Target fishery for each record

Fishery_type<-TargetFishery[match(CSBdata[,"Target_TXN_Code"],TargetFishery[,"TXN_Code"]),"Fishery"]

CSBdata<-cbind(CSBdata,Fishery_type)
dimnames(CSBdata)[[2]][length(names(CSBdata))]<-"Fishery_type"

```
  
The identification of target species on the submission forms seemed very poor in the early years with obvious misassignments.  **These were not used in the final analysis**.  Instead, the gear code was used to determine the type of fishery.

**Gear Group**  
  
CSB data: Catch for each gear type in each year  
  
  
```{r, echo=FALSE}
addmargins(xtabs(Green_Weight ~ Calendar_Year + GTY_Code, CSBdata))


```


In order to simplify comparisons, all otter trawls were grouped into one gear group.  Other trawls were also grouped.  

```{r CSB_Gear_Group, echo=FALSE}
GearGroup<-CSBdata[,"GTY_Code"]
GearGroup[CSBdata[,"GTY_Code"]=="OTB" | CSBdata[,"GTY_Code"]=="OTM"] <- "OT"
GearGroup[CSBdata[,"GTY_Code"]=="SX" | CSBdata[,"GTY_Code"]=="TBB" | CSBdata[,"GTY_Code"]=="TM" | CSBdata[,"GTY_Code"]=="TMB"] <- "TX"
CSBdata<-cbind(CSBdata,GearGroup)
dimnames(CSBdata)[[2]][length(names(CSBdata))]<-"Gear_Group"
print(sort(unique(GearGroup)))

```
  
**Seasons**  
  
Fishing seasons are now designated as 1 December through to 30 November.  The season is assigned to the calendar year of 30 November.
A vector of "**Season**" is bound to the catch data table.  For records missing values in "Month", the season is determined to be the same as that record's calendar year. 

```{r CSB-Seasons, echo=FALSE}
# check for missing values
cat("Season: check for missing values\n     Number of records = "
    ,nrow(CSBdata),"  : Records not missing = ",length(CSBdata[!is.na(CSBdata[,"Calendar_Year"]),"Calendar_Year"]))

CSB_Season<-CSBdata[,"Calendar_Year"]
CSB_Month<-CSBdata[,"Month"]
CSB_Month_Dec<-(CSB_Month[!is.na(CSB_Month)]==12)
CSB_Season[!is.na(CSB_Month)][CSB_Month_Dec]<-CSB_Season[!is.na(CSB_Month)][CSB_Month_Dec]+1

CSBdata<-cbind(CSBdata,CSB_Season)
dimnames(CSBdata)[[2]][length(names(CSBdata))]<-"Season"
```


**CCAMLR Statistical Area**

CCAMLR Statistical Areas are divided according to ocean basins - Atlantic (Area 48), Indian (Area 58) and Pacific (Area 88).  Apart from Statistical Subarea 48.1 and Division 58.4.1, The Statistical Areas roughly coincide with MEASO Sectors in the early years.  Statistical Areas are used to summarise how fishery types (targetted species groups) and fishing types (methods of fishing) progressed over the years.

```{r CSB-StatisticalAreas, echo=FALSE}
# check for missing values
cat("CCAMLR Geographic Areas: check for missing values\n     Number of records = "
    ,nrow(CSBdata),"  : Records not missing = ",length(CSBdata[!is.na(CSBdata[,"GAR_Code"]),"GAR_Code"]))

CSB_Stat_Area<-CRgeographicArea[match(CSBdata[,"GAR_Code"],CRgeographicArea[,"GAR_Code"]),"StatArea"]

CSBdata<-cbind(CSBdata,CSB_Stat_Area)
dimnames(CSBdata)[[2]][length(names(CSBdata))]<-"CSB_Stat_Area"
```


**Catch Groups**  
  
Annual catch of major taxonomic groups is to be reported.  A variable indicating the taxonomic group to which the record applies is added here.

```{r CSB-Taxa_Group, echo=FALSE}
Taxa_Group<-CSB_taxa[match(CSBdata[,"Catch_TXN_Code"],CSB_taxa[,"TXN_Code"]),"Taxa_Group"]

CSBdata<-cbind(CSBdata,Taxa_Group)
dimnames(CSBdata)[[2]][length(names(CSBdata))]<-"Taxa_Group"
```


**Summarise data**

CSBdata variables:  
 [1] "AFC_ID"          "AFE_ID"          "Flag_CTY_Code"   "Calendar_Year"   "Month"
 [6] "GAR_Code"        "Target_TXN_Code" "GTY_Code"        "FAC_Code"        "VSZ_Code"       
[11] "Catch_TXN_Code"  "Green_Weight"    "Fishery_type"    "Gear_Group"      "Season"           
[16] "CSB_Stat_Area"   "Taxa_Group"


```{r CSB-Fishing type-x-TaxaGroup-inYears, echo=FALSE}

# check for missing values
cat("Fishing type: check for missing values\n     Number of records = "
    ,nrow(CSBdata),"  : Records not missing = ",length(CSBdata[!is.na(CSBdata[,"GTY_Code"]),"GTY_Code"]))

res<-aggregate(CSBdata[,"Green_Weight"],list(CSBdata[,"GTY_Code"],CSBdata[,"Taxa_Group"],CSBdata[,"Season"]),sum)
dimnames(res)[[2]]<-c("GTY_Code","Taxa_Group","Season","Green_Weight")

# check have all catch
cat("Catch (tonnes): check totals\n     Grand Total = "
    ,sum(CSBdata[,"Green_Weight"]),"  : Aggregate sum = ",sum(res[,"Green_Weight"]))

vGear<-sort(unique(res[,"GTY_Code"]))

fnSummariseCatchByGear<-function(vG,Res){
               res1<-Res[Res[,"GTY_Code"]==vG,c("Taxa_Group","Season","Green_Weight")]
               vSeason<-sort(unique(res1[,"Season"]))
               vTaxa_Group<-sort(unique(res1[,"Taxa_Group"]))
               ret<-sapply(vTaxa_Group,function(tg,Rd,ssn){
                    Rd1<-Rd[Rd[,"Taxa_Group"]==tg,]
                    rd<-ssn*0
                    matchRes<-match(ssn,Rd1[,"Season"])
                    matchRes<-!is.na(matchRes)
                    rd[matchRes]<-Rd1[,"Green_Weight"]
                    rd
                    },res1,vSeason) # end sapply
               ret<-matrix(ret,ncol=length(vTaxa_Group))
               dimnames(ret)[[1]]<-vSeason
               dimnames(ret)[[2]]<-vTaxa_Group
               ret
                }


Summary01<-lapply(vGear,fnSummariseCatchByGear,res) # end summary
names(Summary01)<-vGear
Summary01
```
  
  
**Check catch of target species in other fisheries**

```{r , echo=FALSE}
# cross tab of combined otter trawl data
#x<-CSBdata[CSBdata[,"GTY_Code"]=="OTM",c("Catch_TXN_Code","Season","Green_Weight")]
#CSB_taxa[CSB_taxa[,"TXN_Code"] %in% unique(x[,"Catch_TXN_Code"]),]
#x<-x[x[,"Green_Weight"]>300,]
#addmargins(xtabs(Green_Weight ~ Season + Catch_TXN_Code, x))

cat("Catch of toothfish in other fisheries","\n")
x <- CSBdata[CSBdata[,"Catch_TXN_Code"]=="TOT"| CSBdata[,"Catch_TXN_Code"]=="TOA" | CSBdata[,"Catch_TXN_Code"]=="TOP",]
addmargins(xtabs(Green_Weight ~ Season + Target_TXN_Code, x))

cat("Catch of krill in other fisheries","\n")
x <- CSBdata[CSBdata[,"Catch_TXN_Code"]=="KRI",]
addmargins(xtabs(Green_Weight ~ Season + Target_TXN_Code, x))

cat("Catch of myctophids in other fisheries","\n")
x <- CSBdata[CSBdata[,"Taxa_Group"]=="Mesopelagic",]
addmargins(xtabs(Green_Weight ~ Season + Target_TXN_Code, x))

cat("Catch of silver fish in other fisheries","\n")
x <- CSBdata[CSBdata[,"Catch_TXN_Code"]=="ANS",]
addmargins(xtabs(Green_Weight ~ Season + Target_TXN_Code, x))

cat("Catch of mackerel icefish in other fisheries","\n")
x <- CSBdata[CSBdata[,"Catch_TXN_Code"]=="ANI",]
addmargins(xtabs(Green_Weight ~ Season + Target_TXN_Code, x))
```

```{r , echo=FALSE}
#cat("Total Catch by year for each fishery","\n")
#x <- CSBdata
#addmargins(xtabs(Green_Weight ~ Season + Target_TXN_Code, x))
cat("Total Catch by geartype for each fishery","\n")
x <- CSBdata
addmargins(xtabs(Green_Weight ~ Target_TXN_Code + GTY_Code, x))

```
### Plot Total Catches per year of main groups

```{r,echo=FALSE}
CSBdata[,"TaxaPlot"]<-CSBdata[,"Taxa_Group"]
CSBdata[CSBdata[,"Catch_TXN_Code"]=="TOP" | CSBdata[,"Catch_TXN_Code"]=="TOA" | CSBdata[,"Catch_TXN_Code"]=="TOT","TaxaPlot"]<-"TOT" # toothfish
CSBdata[CSBdata[,"Catch_TXN_Code"]=="NOR","TaxaPlot"]<-"NOR" # Notothenia rossii
CSBdata[CSBdata[,"Catch_TXN_Code"]=="ANS","TaxaPlot"]<-"ANS" # Pleurogramma
CSBdata[CSBdata[,"Catch_TXN_Code"]=="ANI","TaxaPlot"]<-"ANI" # mackerel icefish
res<-xtabs(Green_Weight ~ Season + TaxaPlot, CSBdata)
Season<-rep(as.numeric(dimnames(res)[[1]]),ncol(res))
Taxa<-as.vector(matrix(rep(dimnames(res)[[2]],nrow(res)),ncol=ncol(res),byrow=TRUE))

pd<-as.data.frame(cbind(Season,Taxa,as.vector(res)))

dimnames(pd)[[2]]<-c("Season","Taxa","Tonnes")
pd[,"Taxa"]<-as.factor(pd[,"Taxa"])

```

Groundfish: "NOR", "TOT", "Nototheniidae"
Icefish:  "ANI", "Channichthyidae"
Pelagic: "Krill", "Mesopelagic", "ANS", "Cephalopod"
Other fisheries: "Crab"
Bycatch:  "Skate", "Macrouridae", "Bathydraconidae", "Benthos"
Other bycatch: "Crustacea","Flying Bird","Lobster", "Other","Shark","Shrimp","Zooplankton"  


```{r,echo=FALSE}
# in order to plot on log10 axis - make zeros equal to 1E-2
#res[res==0]<-1E-2

# Groundfish: "NOR", "TOT", "Nototheniidae"
p <- ggplot(pd[pd[,"Taxa"]=="NOR" | pd[,"Taxa"]=="TOT" | pd[,"Taxa"]=="Nototheniidae",],aes(x=Season,y=Tonnes,group=Taxa))+geom_line() + geom_line(aes(col=Taxa,lintetype=Taxa)) + scale_color_manual(values=c("darkslategrey","darkslategrey","darkslategrey","darkslategrey"))

p<-p + labs(x = "Season", y ="Catch (tonnes)", title="Groundfish")
p<-p+scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),labels = trans_format("log10", math_format(10^.x)))
p
```

# Icefish:  "ANI", "Channichthyidae"

# Pelagic: "Krill", "Mesopelagic", "ANS", "Cephalopod"

p <- ggplot(res) 
p<-p + labs(x = "Season", y ="Catch (tonnes)")

p<-p+geom_line(aes(x=Seasons, y = Krill),col="tomato4",size=1.5, linetype="solid")

# Other fisheries: "Crab"

# Bycatch:  "Skate", "Macrouridae", "Bathydraconidae", "Benthos"

# Other bycatch: "Crustacea","Flying Bird","Lobster", "Other","Shark","Shrimp","Zooplankton"  


```

  
### Catches by Statistical Area

```{Catches-Stat-Area,echo=FALSE}
res<-aggregate(CSBdata[,"Green_Weight"],list(CSBdata[,"CSB_Stat_Area"],CSBdata[,"GTY_Code"],CSBdata[,"Taxa_Group"],CSBdata[,"Season"]),sum)
dimnames(res)[[2]]<-c("CSB_Stat_Area","GTY_Code","Taxa_Group","Season","Green_Weight")
vStatArea<-sort(unique(res[,"CSB_Stat_Area"]))
vStatArea
head(res)

Summary02<-lapply(vStatArea,function(Area,Res,fnCatch){
          res1<-Res[Res[,"CSB_Stat_Area"]==as.numeric(Area),c("GTY_Code","Taxa_Group","Season","Green_Weight")]
          vGear1<-sort(unique(res1[,"GTY_Code"]))
          ret<-lapply(vGear1,fnCatch,res1)
          names(ret)<-vGear1
          ret   
            },res,fnSummariseCatchByGear)
names(Summary02)<-as.character(vStatArea)
Summary02
```
  
  
  
## Extraction for MEASO Areas
  
CCAMLR provided the data in a CSV file 'extract_462_MEASO_areas.csv'.  It was noted that the data were released in accordance with CCAMLR Data Access Rules.  It was also noted that data prior to 1995 may not be complete; checks need to be made against the statistical bulletin.  Annotations on each column were provided:  
  
```{r MEASO-Catch-Data-Load, echo=FALSE}
MCdata<-read.csv2(paste(WorkDir,'CCAMLR MEASO extraction\\extract_462_MEASO_areas.csv',sep=""), header = TRUE, sep = ",", dec = ".")

#check each column
print ("Factors: Unique values in raw data file")
cat("Ctype\n")
sort(unique(MCdata[,"Ctype"]))
cat("Fishing type\n")
sort(unique(MCdata[,"Fishing_type"]))
cat("MEASO area\n")
sort(unique(MCdata[,"MEASO_Area"]))
cat("Season\n")
sort(unique(MCdata[,"Season"]))
cat("Species code\n")
sort(unique(MCdata[,"Species_code"]))
```

### Factor & Variable descriptions

**Ctype** – The origin data base for the extract; 

```{r MR-Ctype,echo=FALSE}
MR_Ctype<-matrix(c("C1","Trawl fishery"
               ,"C2","Longline fishery"
               ,"C3","Squid fishery"
               ,"C4","Research trawl"
               ,"C5","Crab fishery"),ncol=2,byrow=TRUE)
MR_Ctype
```
  
**Fishing_type** – Which type of gear was used to collect the data. For trawling a distinction is made for bottom and midwater trawling.  

```{r MR-GearType,echo=FALSE}
MR_GearType<-matrix(c("Bottom trawl","Midwater trawl","Unknown trawl"
           ,"Longlines","Squid Jigger","Traps, Pots","OT","OT","OT","LLS","JIG","FPO"),ncol=2)
dimnames(MR_GearType)[[2]]<-c("Fishing_type","Gear_Group")
MR_GearType
``` 
  
**MEASO_Area** – The 3-letter code for the MEASO area in which the coordinates are located. When data did not fall within in a MEASO area a null value is provided.  

```{r MR-MEASO-areas,echo=FALSE}
MEASOareas<-matrix(c("AOA","Atlantic Ocean","Antarctic","48"
                    ,"AOS","Atlantic Ocean","Subantarctic","48"
                    ,"AON","Atlantic Ocean","Northern","48"
                    ,"CIA","Central Indian","Antarctic","58"
                    ,"CIS","Central Indian","Subantarctic","58" 
                    ,"CIN","Central Indian","Northern","58"
                    ,"EIA","East Indian   ","Antarctic","58"
                    ,"EIS","East Indian   ","Subantarctic",""
                    ,"EPA","East Pacific  ","Antarctic","48"
                    ,"EPS","East Pacific  ","Subantarctic","48"
                    ,"WPA","West Pacific  ","Antarctic","88"
                    ,"WPS","West Pacific  ","Subantarctic",""
                    ,"",    "not in MEASO area","",""),byrow=TRUE,ncol=4)
dimnames(MEASOareas)[[2]]<-c("Code","Sector","Zone","CSB_Stat_Area")
MEASOareas
```

**Season** – The year data was sampled according to the CCAMLR calendar. A CCAMLR season runs from 1 December of the previous calendar year until 30 November of the calendar year provided as the value in the field Season. For example, 2018-12-05 and 2019-05-14 both occur in Season 2019.  

```{r MR-Seasons,echo=FALSE}
MR_Seasons<-c(               1973,1974,1975,1976,1977,1978,1979
          ,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989
          ,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999
          ,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009
          ,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019
          ,2020)
MR_Seasons
```

**Effort_in_meters** – For C4 data, for some hauls the trawling distance was recorded as a distance. The number given refers to the total effort for an MEASO_Area, Season, Fishing_type combination.  
  
**Effort_in_hours** – For the C1 data this either “the time difference between the set_end_date and the haul_start_date” or when haul start dates or set_end_dates were not provided the number of fishing hours. Number of fishing hours is mainly associated to aggregated data submission and is not provided for recent submissions. When neither haul_start/set_end_date or number of fishing hours are available then the record is empty.  
For the C3 data this is the time difference between the drift-end-time and the drift-start-time.  
For the C4 data this the trawl duration (if provided).  
For the C5 data is the soak-time (if provided).  The number given refers to the total effort for an MEASO_Area, Season, Fishing_type combination.  
  
**Number_of_hooks_set** – For the C2 data the number of hooks that are set. The number given refers to the total effort for an MEASO_Area, Season, Fishing_type combination.  
  
**Species_code** – The FAO-AFSIS code referring to the taxon that was caught.  
  
**Species_name** – The scientific name of the taxon that was caught. Only the 20 most abundant taxa according to biomass (per data type) are included in the extract.  (Species codes and names based on the ReferenceDataTaxon file provided by CCAMLR.  Groupings of Taxa for MEASO summaries were added to that file and used here to show groupings in the MEASO extraction)
  
```{r MEASOdata-species,echo=FALSE}
# Grouping based on codes from CCAMLR data
unique(CSB_taxa[match(MCdata[,"Species_code"],CSB_taxa[,"TXN_Code"]),c(1:4)])

```
  
**Tonnage** – The total weight in tons of the taxa recorded in the species name field that was caught for the MEASO_Area, Season, Fishing_type combination. In those cases where some hauls in the “MEASO_Area, Season, Fishing_type” combination provide an effort and some don’t , the tonnage is split accordingly so that one tonnage value reflects the effort listed while the other reflects a the unrecorded effort (provided as a null value).  


## Comparison of Bulletin and Haul datasets
  
Catch records have been assigned from the CCAMLR Statistical Bulletin into the following dataframe (CSBdata) variables:  
  "CSB_Stat_Area" - Statistical Area   
  "Gear_Group"    - grouping of gear types ("GTY_Code") - Pots, Jigs, Trawls, Longlines  
  "Taxa_Group"    - broad grouping of taxa for summarising and comparing  
  "Season"        - CCAMLR fishing season as the second calendar year in the period,  
                    1 December to 30 November  
  "Green_Weight"  - catch in tonnes  
  
The MEASO data are assigned into a similar form with comparable variables, respectively:  
  "MEASO_Sector", "CSB_Stat_Area", "Gear_Group", "Taxa_Group", "Season", "Tonnage"  
  
  
```{r MEASO_catch_aggregation, echo=FALSE}
# create missing grouping variables in MEASO data set

M_Taxa_Group<-CSB_taxa[match(MCdata[,"Species_code"],CSB_taxa[,"TXN_Code"]),"Taxa_Group"]
MCdata<-cbind(MCdata,M_Taxa_Group)
dimnames(MCdata)[[2]][length(names(MCdata))]<-"Taxa_Group"
print(sort(unique(M_Taxa_Group)))

M_Sector<-MEASOareas[match(MCdata[,"MEASO_Area"],MEASOareas[,"Code"]),"Sector"]
MCdata<-cbind(MCdata,M_Sector)
dimnames(MCdata)[[2]][length(names(MCdata))]<-"MEASO_Sector"
print(sort(unique(M_Sector)))

M_CSB_Stat_Area<-MEASOareas[match(MCdata[,"MEASO_Area"],MEASOareas[,"Code"]),"CSB_Stat_Area"]
MCdata<-cbind(MCdata,M_CSB_Stat_Area)
dimnames(MCdata)[[2]][length(names(MCdata))]<-"CSB_Stat_Area"
print(sort(unique(M_CSB_Stat_Area)))

M_GearGroup<-MR_GearType[match(MCdata[,"Fishing_type"],MR_GearType[,"Fishing_type"]),"Gear_Group"]
MCdata<-cbind(MCdata,M_GearGroup)
dimnames(MCdata)[[2]][length(names(MCdata))]<-"Gear_Group"
print(sort(unique(M_GearGroup)))

```


```{r aggregate-data,echo=FALSE}

# Aggregate each as whole of area and print when difference is greater than tolerance.
aggMC<-aggregate(MCdata[,"Tonnage"],list(MCdata[,"Season"],MCdata[,"Taxa_Group"],MCdata[,"Fishing_type"],MCdata[,"CSB_Stat_Area"]),sum)
dimnames(aggMC)[[2]]<-c("Season","Taxa_Group","Fishing_type","CSB_Stat_Area","Tonnage")

# Aggregate each as whole of area and print when difference is greater than tolerance.
aggCSB<-aggregate(CSBdata[,"Green_Weight"],list(CSBdata[,"Season"],CSBdata[,"Taxa_Group"],CSBdata[,"GTY_Code"],CSBdata[,"CSB_Stat_Area"]),sum)
dimnames(aggCSB)[[2]]<-c("Season","Taxa_Group","GTY_Code","CSB_Stat_Area","Green_Weight")


```

```{r CatchDiff-functions,echo=FALSE}

YearsOfGearTypes<-function(Target     # target Taxa_Group 
                          ,Threshold  # threshold catch for comparing
                          ,Tol        # tolerance for proportional difference considered important
                          ,MCdata         # MEASO dataset to be aggregated and compared
                          ,CSBdata        # CSB dataset to be aggregated and compared
                          ){
  # Aggregate each as whole of area and print when difference is greater than tolerance.
MC<-aggregate(MCdata[,"Tonnage"],list(MCdata[,"Season"],MCdata[,"Taxa_Group"],MCdata[,"Fishing_type"],MCdata[,"CSB_Stat_Area"]),sum)
dimnames(MC)[[2]]<-c("Season","Taxa_Group","Fishing_type","CSB_Stat_Area","Tonnage")

# Aggregate each as whole of area and print when difference is greater than tolerance.
CSB<-aggregate(CSBdata[,"Green_Weight"],list(CSBdata[,"Season"],CSBdata[,"Taxa_Group"],CSBdata[,"GTY_Code"],CSBdata[,"CSB_Stat_Area"]),sum)
dimnames(CSB)[[2]]<-c("Season","Taxa_Group","GTY_Code","CSB_Stat_Area","Green_Weight")

  
  aggDM<-MC[MC[,"Taxa_Group"]==Target & MC[,"Tonnage"]>Threshold,]
  aggDC<-CSB[CSB[,"Taxa_Group"]==Target & CSB[,"Green_Weight"]>Threshold,]

  cat(Target," catches greater than ",Threshold," tonnes are examined for attributes and comparison between data sets.\n\n",sep="")
  
  res<-aggregate(aggDM[,"Season"],list(aggDM[,"Fishing_type"]),length)
  dimnames(res)[[2]] <-c("Fishing_type","n")
  
  cat("MEASO data: Number of years in each type of fishery\n")
  print(res)
  cat("\nMEASO data: Years combining all gear types:\n",sort(unique(aggDM[,"Season"])),sep=" ")

  res<-aggregate(aggDC[,"Season"],list(aggDC[,"GTY_Code"]),length)
  dimnames(res)[[2]] <-c("GTY_Code","n")
  cat("\nCSB data: Number of years in each type of fishery\n")
  print(res)
  cat("\nCSB data: Years combining all gear types:\n",sort(unique(aggDC[,"Season"])),sep=" ")
  cat("\n\n")
  
} # end function Years of Gear Types
  
CheckCatchDiff <- function(Target     # target Taxa_Group 
                          ,Threshold  # threshold catch for comparing
                          ,Tol        # tolerance for proportional difference considered important
                          ,MC         # MEASO dataset to be aggregated and compared
                          ,CSB        # CSB dataset to be aggregated and compared
                          ,vAgg         # variables for grouping the aggregation
                          ,Header=TRUE  # lines explaining the comparison
                          ){  

    aggDM<-MC[MC[,"Taxa_Group"]==Target & MC[,"Tonnage"]>Threshold,]
    aggDC<-CSB[CSB[,"Taxa_Group"]==Target & CSB[,"Green_Weight"]>Threshold,]

  if(Header) cat("Incomplete years in MEASO records, "
       ,"determined as the absolute proportional difference\n"
       ,"of the MEASO data relative to the CSB data, with a tolerance of ",Tol,".\n\n",sep="")  
  
  cat("Compare total catch of ",Target," according to the grouping variables: ",vAgg,"\n",sep="")

  fnAgg<-function(Agg,aggD){aggD[,Agg]}
  dMC<-aggregate(aggDM[,"Tonnage"],lapply(vAgg,fnAgg,aggDM),sum)
  dimnames(dMC)[[2]]<-c(vAgg,"Tonnage")

  dCC<-aggregate(aggDC[,"Green_Weight"],lapply(vAgg,fnAgg,aggDC),sum)
  dimnames(dCC)[[2]]<-c(vAgg,"Green_Weight")

  res<-merge(dMC,dCC,by=vAgg,all=TRUE)
  res<-res[!is.na(res[,"Green_Weight"]),]
  res[is.na(res[,"Tonnage"]),"Tonnage"]<-0

  PropDiff<-(res[,"Green_Weight"]-res[,"Tonnage"])/res[,"Green_Weight"]

  Seasons_to_correct<-cbind(res[abs(PropDiff)>Tol,vAgg],PropDiff[abs(PropDiff)>Tol])
  dimnames(Seasons_to_correct)[[2]]<-c(vAgg,"Prop_diff")
  print(Seasons_to_correct)
  Seasons_to_correct
} # end function compare

printAgg_CSB_SeasonsToCorrect <- function(
                    StC        # matrix of Seasons_to_correct
                   ,Target     # target Taxa_Group 
                   ,CSB        # CSB dataset to be aggregated and compared
                   ,xAgg=NULL  # extra variables for grouping the aggregation
                   ,PrintCatch=TRUE  #   FALSE gives n records  
                    ){  
  aggCSB<-CSB[CSB[,"Taxa_Group"]==Target,]
       StC_vAgg<-dimnames(StC)[[2]][c(1:(ncol(StC)-1))]
       
       uniqueStC<-unique(StC[,StC_vAgg]) 
       uniqueStC<-matrix(uniqueStC,ncol=length(StC_vAgg))
       dimnames(uniqueStC)[[2]]<-StC_vAgg
       vAgg<-c(StC_vAgg,xAgg)
       
       fnAgg<-function(Agg,aggD){aggD[,Agg]}
       if(PrintCatch) {res<-aggregate(aggCSB[,"Green_Weight"],lapply(vAgg,fnAgg,aggCSB),sum) 
                            dimnames(res)[[2]]<-c(vAgg,"Green_Weight")
                           } else { 
                            res<-aggregate(aggCSB[,"Green_Weight"],lapply(vAgg,fnAgg,aggCSB),length) 
                            dimnames(res)[[2]]<-c(vAgg,"Records")
                           } # end else
       
       fnStC<-function(StC,Data,Vars){
                       # first identify records that are in Seasons_to_Correct
                           rLogic<-rep(TRUE,nrow(Data))
                           for(i in 1:length(StC)) rLogic<-rLogic & Data[,Vars[i]]==StC[i]
                        # then return relevant records
                         Data[rLogic,]
                        } # end fnStC
        
Vars<-dimnames(uniqueStC)[[2]]
SumRes<-do.call(rbind, apply(uniqueStC,1,fnStC,res,Vars))

SumRes

      } # end printAgg
```



### Krill fishery###
  
```{r echo=FALSE}
T_group<-"Krill"
Comm_catch_threshold<-1000
Tol<-0.05
vCompare<-c("Season")

YearsOfGearTypes(Target     = T_group    # target Taxa_Group 
                ,Threshold  = Comm_catch_threshold # threshold catch for comparing
                ,Tol        = Tol        # tolerance for proportional difference considered important
                ,MCdata     = MCdata      # MEASO dataset to be aggregated and compared
                ,CSBdata     = CSBdata     # CSB dataset to be aggregated and compared
                )# end call

SeasonsToCorrect<-CheckCatchDiff (
                Target     = T_group     # target Taxa_Group 
               ,Threshold  = Comm_catch_threshold # threshold catch for comparing
               ,Tol        = Tol         # tolerance for proportional difference considered important
               ,MC         = MCdata       # MEASO dataset to be aggregated and compared
               ,CSB        = CSBdata      # CSB dataset to be aggregated and compared
               ,vAgg       = vCompare    # variables for grouping the aggregation
               ,Header     = TRUE        # lines explaining the comparison
               ) # end call  

# excluding GAR = 48, 58, 88
CSBdata_excl<-CSBdata
CSBdata_excl<-CSBdata[is.na(match(CSBdata[,"GAR_Code"],c("48","58","88","58.4"))),]
SeasonsToCorrect<-CheckCatchDiff (
                Target     = T_group     # target Taxa_Group 
               ,Threshold  = Comm_catch_threshold # threshold catch for comparing
               ,Tol        = Tol         # tolerance for proportional difference considered important
               ,MC         = MCdata       # MEASO dataset to be aggregated and compared
               ,CSB        = CSBdata_excl      # CSB dataset to be aggregated and compared
               ,vAgg       = vCompare    # variables for grouping the aggregation
               ,Header     = TRUE        # lines explaining the comparison
               ) # end call  

printAgg_CSB_SeasonsToCorrect(
                StC        = SeasonsToCorrect        # matrix of Seasons_to_correct
               ,Target     = T_group      # target Taxa_Group 
               ,CSB        = CSBdata_excl       # CSB dataset to be aggregated and compared
               ,xAgg       = "GAR_Code"       # extra variables for grouping the aggregation
               ,PrintCatch = TRUE         #   FALSE gives n records  
                ) # end call  

```

 


### Notothenid fisheries

Notothenid fisheries include the early groundfish fisheries and the later toothfish fisheries.

Catches greater than **200** tonnes are examined for attributes and comparison between data sets.  

```{r echo=FALSE}
T_group<-"Nototheniidae"
Comm_catch_threshold<-200
Tol<-0.05

```

**MEASO Catch data**

```{r Noto-gear-MC,echo=FALSE}
aggDM<-aggMC[aggMC[,"Taxa_Group"]==T_group & aggMC[,"Tonnage"]>Comm_catch_threshold,]

cat("Number of years in each type of fishery\n")
res<-aggregate(aggDM[,"Season"],list(aggDM[,"Fishing_type"]),length)
dimnames(res)[[2]] <-c("Fishing_type","n")
res

cat("Years combining all gear types:",sort(unique(aggDM[,"Season"])),sep=" ")

```

**CSB Catch data**

```{r Noto-gear-CC,echo=FALSE}

aggDC<-aggCSB[aggCSB[,"Taxa_Group"]==T_group & aggCSB[,"Green_Weight"]>Comm_catch_threshold,]

cat("Number of years in each type of fishery")
res<-aggregate(aggDC[,"Season"],list(aggDC[,"GTY_Code"]),length)
dimnames(res)[[2]] <-c("GTY_Code","n")
res

cat("Years combining all gear types:",sort(unique(aggDC[,"Season"])),sep=" ")

```


**Historical seasons where catch data diverge**

The MEASO dataset will be correct for the recent seasons.  This task is to identify years where there are catches in the CSB data set but not represented well in the MEASO data set. A tolerance level of **0.05** is used as the absolute proportional difference of the MEASO dataset relative to the CSB dataset.


```{r Noto-compare,echo=FALSE}
dMC<-aggregate(aggDM[,"Tonnage"],list(aggDM[,"Season"]),sum)
dimnames(dMC)[[2]]<-c("Season","Tonnage")
dCC<-aggregate(aggDC[,"Green_Weight"],list(aggDC[,"Season"]),sum)
dimnames(dCC)[[2]]<-c("Season","Green_Weight")
res<-merge(dMC,dCC,by=c("Season"),all=TRUE)
res<-res[!is.na(res[,"Green_Weight"]),]
res[is.na(res[,"Tonnage"]),"Tonnage"]<-0
PropDiff<-(res[,"Green_Weight"]-res[,"Tonnage"])/res[,"Green_Weight"]

Noto_Seasons_to_correct<-cbind(res[abs(PropDiff)>Tol,"Season"],PropDiff[abs(PropDiff)>Tol])
dimnames(Noto_Seasons_to_correct)[[2]]<-c("Season","Prop_diff")
Noto_Seasons_to_correct
```


### Icefish fisheries

Icefish fisheries include the early groundfish fisheries and the later mackerel icefish fisheries.

Catches greater than **200** tonnes are examined for attributes and comparison between data sets.  

```{r echo=FALSE}
T_group<-"Channichthyidae"
Comm_catch_threshold<-200
Tol<-0.05

```

**MEASO Catch data**

```{r Icefish-gear-MC,echo=FALSE}
aggDM<-aggMC[aggMC[,"Taxa_Group"]==T_group & aggMC[,"Tonnage"]>Comm_catch_threshold,]

cat("Number of years in each type of fishery\n")
res<-aggregate(aggDM[,"Season"],list(aggDM[,"Fishing_type"]),length)
dimnames(res)[[2]] <-c("Fishing_type","n")
res

cat("Years combining all gear types:",sort(unique(aggDM[,"Season"])),sep=" ")

```

**CSB Catch data**

```{r Icefish-gear-CC,echo=FALSE}

aggDC<-aggCSB[aggCSB[,"Taxa_Group"]==T_group & aggCSB[,"Green_Weight"]>Comm_catch_threshold,]

cat("Number of years in each type of fishery")
res<-aggregate(aggDC[,"Season"],list(aggDC[,"GTY_Code"]),length)
dimnames(res)[[2]] <-c("GTY_Code","n")
res

cat("Years combining all gear types:",sort(unique(aggDC[,"Season"])),sep=" ")

```


**Historical seasons where catch data diverge**

The MEASO dataset will be correct for the recent seasons.  This task is to identify years where there are catches in the CSB data set but not represented well in the MEASO data set. A tolerance level of **0.05** is used as the absolute proportional difference of the MEASO dataset relative to the CSB dataset.


```{r Icefish-compare,echo=FALSE}
dMC<-aggregate(aggDM[,"Tonnage"],list(aggDM[,"Season"]),sum)
dimnames(dMC)[[2]]<-c("Season","Tonnage")
dCC<-aggregate(aggDC[,"Green_Weight"],list(aggDC[,"Season"]),sum)
dimnames(dCC)[[2]]<-c("Season","Green_Weight")
res<-merge(dMC,dCC,by=c("Season"),all=TRUE)
res<-res[!is.na(res[,"Green_Weight"]),]
res[is.na(res[,"Tonnage"]),"Tonnage"]<-0
PropDiff<-(res[,"Green_Weight"]-res[,"Tonnage"])/res[,"Green_Weight"]

Icefish_Seasons_to_correct<-cbind(res[abs(PropDiff)>Tol,"Season"],PropDiff[abs(PropDiff)>Tol])
dimnames(Icefish_Seasons_to_correct)[[2]]<-c("Season","Prop_diff")
Icefish_Seasons_to_correct
```

### Mesopelagics

Mesopelagic fisheries primarily relate to catches of myctophids but may include silverfish.

Catches greater than **500** tonnes are examined for attributes and comparison between data sets.  

```{r echo=FALSE}
T_group<-"Mesopelagic"
Comm_catch_threshold<-500
Tol<-0.05

```

**MEASO Catch data**

```{r Mycto-gear-MC,echo=FALSE}
aggDM<-aggMC[aggMC[,"Taxa_Group"]==T_group & aggMC[,"Tonnage"]>Comm_catch_threshold,]

cat("Number of years in each type of fishery\n")
res<-aggregate(aggDM[,"Season"],list(aggDM[,"Fishing_type"]),length)
dimnames(res)[[2]] <-c("Fishing_type","n")
res

cat("Years combining all gear types:",sort(unique(aggDM[,"Season"])),sep=" ")

```

**CSB Catch data**

```{r Mycto-gear-CC,echo=FALSE}

aggDC<-aggCSB[aggCSB[,"Taxa_Group"]==T_group & aggCSB[,"Green_Weight"]>Comm_catch_threshold,]

cat("Number of years in each type of fishery")
res<-aggregate(aggDC[,"Season"],list(aggDC[,"GTY_Code"]),length)
dimnames(res)[[2]] <-c("GTY_Code","n")
res

cat("Years combining all gear types:",sort(unique(aggDC[,"Season"])),sep=" ")

```


**Historical seasons where catch data diverge**

The MEASO dataset will be correct for the recent seasons.  This task is to identify years where there are catches in the CSB data set but not represented well in the MEASO data set. A tolerance level of **0.05** is used as the absolute proportional difference of the MEASO dataset relative to the CSB dataset.


```{r Mycto-compare,echo=FALSE}
dMC<-aggregate(aggDM[,"Tonnage"],list(aggDM[,"Season"]),sum)
dimnames(dMC)[[2]]<-c("Season","Tonnage")
dCC<-aggregate(aggDC[,"Green_Weight"],list(aggDC[,"Season"]),sum)
dimnames(dCC)[[2]]<-c("Season","Green_Weight")
res<-merge(dMC,dCC,by=c("Season"),all=TRUE)
res<-res[!is.na(res[,"Green_Weight"]),]
res[is.na(res[,"Tonnage"]),"Tonnage"]<-0
PropDiff<-(res[,"Green_Weight"]-res[,"Tonnage"])/res[,"Green_Weight"]

Mycto_Seasons_to_correct<-cbind(res[abs(PropDiff)>Tol,"Season"],PropDiff[abs(PropDiff)>Tol])
dimnames(Mycto_Seasons_to_correct)[[2]]<-c("Season","Prop_diff")
Mycto_Seasons_to_correct
```

### Squid

Squid fisheries were primarily of flying squid.

Catches greater than **500** tonnes are examined for attributes and comparison between data sets.  

```{r echo=FALSE}
T_group<-"Cephalopod"
Comm_catch_threshold<-10
Tol<-0.05

```

**MEASO Catch data**

```{r Squid-gear-MC,echo=FALSE}
aggDM<-aggMC[aggMC[,"Taxa_Group"]==T_group & aggMC[,"Tonnage"]>Comm_catch_threshold,]

cat("Number of years in each type of fishery\n")
res<-aggregate(aggDM[,"Season"],list(aggDM[,"Fishing_type"]),length)
dimnames(res)[[2]] <-c("Fishing_type","n")
res

cat("Years combining all gear types:",sort(unique(aggDM[,"Season"])),sep=" ")

```

**CSB Catch data**

```{r Squid-gear-CC,echo=FALSE}

aggDC<-aggCSB[aggCSB[,"Taxa_Group"]==T_group & aggCSB[,"Green_Weight"]>Comm_catch_threshold,]

cat("Number of years in each type of fishery")
res<-aggregate(aggDC[,"Season"],list(aggDC[,"GTY_Code"]),length)
dimnames(res)[[2]] <-c("GTY_Code","n")
res

cat("Years combining all gear types:",sort(unique(aggDC[,"Season"])),sep=" ")

```


**Historical seasons where catch data diverge**

The MEASO dataset will be correct for the recent seasons.  This task is to identify years where there are catches in the CSB data set but not represented well in the MEASO data set. A tolerance level of **0.05** is used as the absolute proportional difference of the MEASO dataset relative to the CSB dataset.


```{r Squid-compare,echo=FALSE}
dMC<-aggregate(aggDM[,"Tonnage"],list(aggDM[,"Season"]),sum)
dimnames(dMC)[[2]]<-c("Season","Tonnage")
dCC<-aggregate(aggDC[,"Green_Weight"],list(aggDC[,"Season"]),sum)
dimnames(dCC)[[2]]<-c("Season","Green_Weight")
res<-merge(dMC,dCC,by=c("Season"),all=TRUE)
res<-res[!is.na(res[,"Green_Weight"]),]
res[is.na(res[,"Tonnage"]),"Tonnage"]<-0
PropDiff<-(res[,"Green_Weight"]-res[,"Tonnage"])/res[,"Green_Weight"]

Squid_Seasons_to_correct<-cbind(res[abs(PropDiff)>Tol,"Season"],PropDiff[abs(PropDiff)>Tol])
dimnames(Squid_Seasons_to_correct)[[2]]<-c("Season","Prop_diff")
Squid_Seasons_to_correct
```


## Data amalgamation into MEASO areas


  
## Results

### Finfish
  
MEASO data - subset data to 
  
```{r echo=FALSE}
# Subset data
MCdata_MEASO_NA<-MCdata[MCdata[,"MEASO_Area"]=="",]  # data outside MEASO areas

# subset Cdata to not include catches not allocated to MEASO Areas
MCdata_MEASO<-MCdata[MCdata[,"MEASO_Area"]!="",]

# factors
fCtype<-factor(MCdata_MEASO[,'Ctype'])
fMEASO_Area<-factor(MCdata_MEASO[,'MEASO_Area'])
fSector<-factor(MEASOareas[match(MCdata_MEASO[,"MEASO_Area"],MEASOareas[,"Code"]),"Sector"])
fZone<-factor(MEASOareas[match(MCdata_MEASO[,"MEASO_Area"],MEASOareas[,"Code"]),"Zone"])
fYear<-factor(MCdata_MEASO[,'Season'])
fTaxaGroups<-factor(CSB_taxa[match(MCdata_MEASO[,"Species_code"],CSB_taxa[,"TXN_Code"]),"Taxa_Group"])

MCdata_MEASO<-cbind(fCtype,fMEASO_Area,fSector,fZone,fYear,fTaxaGroups,MCdata_MEASO)
cat("Cdata_MEASO - is it data.frame = ",is.data.frame(MCdata_MEASO),"\n",sep="")
cat("CSBdata_MEASO: variables\n")
dimnames(MCdata_MEASO)[[2]]
MCdata_MEASO<-MCdata_MEASO[order(fTaxaGroups,fYear,fMEASO_Area),]
cat("Cdata_MEASO records = ",nrow(MCdata_MEASO),"\n",sep="")
cat("Cdata_MEASO first records\n")
head(MCdata_MEASO)


```

#### aggregate catches by taxonomic group
```{r, echo=FALSE}
library(ggplot2)



# aggregate catches by taxonomic group
Groups<-list(
#          ,fSector = MCdata_MEASO[,"fSector"]
#          ,fZone =  MCdata_MEASO[,"fZone"]
           fTaxaGroups = MCdata_MEASO[,"fTaxaGroups"]
            )# end Groups
DVname<-"Tonnage"
DV<-MCdata_MEASO[,DVname]  # dependent variable
MCbA<-aggregate(DV,by=Groups,"sum")
dimnames(MCbA)[[2]]<- c(names(Groups),DVname)
MCbA

# Catch by area
Groups<-list(
           fSector = MCdata_MEASO[,"fSector"]
#          ,fZone =  MCdata_MEASO[,"fZone"]
          ,fTaxaGroups = MCdata_MEASO[,"fTaxaGroups"]
            )# end Groups
DVname<-"Tonnage"
DV<-MCdata_MEASO[,DVname]  # dependent variable

cat("Catch by Area factors = ",paste(names(Groups),sep=", "),"\n",sep=" ")

MCbA<-aggregate(DV,by=Groups,"length")
cat("Catch by Area records = ",sum(MCbA[,ncol(MCbA)]),"\n",sep="")

MCbA<-aggregate(DV,by=Groups,"sum")
dimnames(MCbA)[[2]]<- c(names(Groups),DVname)

cat("Catch by Area: variables",names(MCbA),"\n", sep=" ")

head(MCbA)

cp <- ggplot(MCbA, aes(x=fTaxaGroups, y=Tonnage, color=fTaxaGroups)) + 
  geom_bar(stat="identity")
cp <- cp + facet_grid(.~fSector)
cp


```
  
**also include IUU fishing**

  
### Krill
  

### Bycatch  

## Effort

### Pelagic trawl

### Bottom trawl

### Bottom longline


# Whales

Mike Double is providing this.
also look at CCAMLR-IWC workshop paper

# Seals

look at CCAMLR-IWC workshop paper


# Southern Ocean flying birds

see 
IMAF reports (take account of IUU)
www.acap.aq 
recent papers....


# Attachments

## Attachment A: Email from CCAMLR Secretariat in which data were provided

From: Daphnis De Pooter <Daphnis.DePooter@ccamlr.org>  
Sent: Thursday, 16 January 2020 4:02 PM  
To: Andrew Constable <Andrew.Constable@aad.gov.au>; Dirk Welsford  <Dirk.Welsford@aad.gov.au>  
Cc: ccamlr@ccamlr.org  
Subject: Release of data: 462_CCAMLR_C1_C2_C3_C4_C5_aggr_by_MEASO_zone [SEC=UNCLASSIFIED]  
  
Dear Andrew and Dirk,  
  
The data requested has been extracted. Through the link bottom of this email you will obtain a .csv file with the requested data and a .docx file with a description of the fields included in the extract. Please let me know if you have any questions regarding the content of the extract or methodology used to produce it. This extract is as of 16 January 2020. These data are available for a limited time as a secure download.  
  
These data have been released in accordance with CCAMLR’s rules for data access and use, and for the purpose stated in your email. Data owners will be advised of this data release, and may contact you directly should they wish to provide advice on the use of their data and/or collaborate in the analyses and reporting (paragraph 6 of the Rules). Also, please note that this release of data does not constitute permission to publish or release data into the public domain. Such permission remains a matter to be determined between the requestor and the data originators, and the Secretariat may assist with this process.  
  
Please note that the data in this extract may not represent the entire catch of a particular species for time series prior to about 1995, for which data which are available in the Statistical Bulletin. We assume that the authors will use this publicly accessible data source to understand data coverage of the C series data in the early years.  
  
Kind regards,  
  
Daphnis De Pooter  
Science Data Officer  
Commission for the Conservation of Antarctic Marine Living Resources  
Phone: +61 3 6210 1145  
Web: www.ccamlr.org  
Email: daphnis.depooter@ccalmr.org  
Files attached to this message  "extract_462_MEASO_areas.zip" 53 KB  	

